<div class="container">
  <h2 class="mb-4">Sipariş Yönetimi</h2>
  
  <div *ngIf="!isAdmin" class="alert alert-danger">
    <strong>Erişim Reddedildi!</strong> Bu sayfayı görüntülemek için yönetici ayrıcalıklarına sahip olmanız gerekir.
    <div class="mt-2">Kısa süre içinde ana sayfaya yönlendirileceksiniz...</div>
  </div>
  
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Yükleniyor...</span>
    </div>
  </div>
  
  <div *ngIf="error" class="alert alert-danger">
    <strong>Hata:</strong> {{ error }}
  </div>

  <div *ngIf="!loading && !error && orders.length === 0 && isAdmin" class="alert alert-info">
    Sistemde sipariş bulunamadı.
  </div>

  <div class="mb-3">
    <button class="btn btn-primary" (click)="refreshOrders()" [disabled]="loading">
      <i class="bi bi-arrow-clockwise me-2"></i>Siparişleri Yenile
    </button>
  </div>
  
  <div *ngIf="orders.length > 0" class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th scope="col">Sipariş NO</th>
          <th scope="col">Tarih</th>
          <th scope="col">Müşteri</th>
          <th scope="col">Toplam Tutar</th>
          <th scope="col">Durum</th>
          <th scope="col">İşlemler</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let order of orders; let i = index">
          <tr>
            <td>#{{ order.id }}</td>
            <td>{{ order.createdAt | date:'medium' }}</td>
            <td>{{ order.customerFullName || 'Bilinmiyor' }}</td>
            <td>₺{{ order.totalPrice ? order.totalPrice.toFixed(2) : '0.00' }}</td>
            <td>
              <span class="badge" [ngClass]="getStatusClass(order.status)">
                {{ getStatusTranslation(order.status) }}
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-info" (click)="toggleOrderDetails(i)">
                <i class="bi" [ngClass]="expandedOrderIndex === i ? 'bi-chevron-up' : 'bi-chevron-down'"></i> Detaylar
              </button>
            </td>
          </tr>
          <!-- Expanded Order Details -->
          <tr *ngIf="expandedOrderIndex === i">
            <td colspan="6">
              <div class="card p-3 bg-light">
                <h5 class="mb-3">Sipariş Ürünleri</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Görsel</th>
                      <th>Ürün</th>
                      <th>Fiyat</th>
                      <th>Adet</th>
                      <th>Satıcı</th>
                      <th>Durum</th>
                      <th>İşlemler</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of order.items">
                      <td>
                        <img [src]="item.imageUrl || 'assets/img/no-image.png'" 
                             alt="{{ item.productName }}" 
                             class="img-thumbnail product-thumbnail"
                             style="width: 60px; height: 60px; object-fit: cover;">
                      </td>
                      <td>{{ item.productName }}</td>
                      <td>₺{{ item.priceAtPurchase ? item.priceAtPurchase.toFixed(2) : '0.00' }}</td>
                      <td>{{ item.quantity }}</td>
                      <td>{{ item.sellerName || 'Bilinmeyen Satıcı' }}</td>
                      <td>
                        <span class="badge" [ngClass]="getItemStatusClass(item.status)">
                          {{ getItemStatusTranslation(item.status) }}
                        </span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary me-1" 
                                title="Ürün Durumunu Değiştir" 
                                (click)="openChangeItemStatusModal(order, item)"
                                [disabled]="item.status === orderItemStatus.DELIVERED || 
                                          item.status === orderItemStatus.CANCELED || 
                                          item.status === orderItemStatus.CANCELLED_BY_SELLER || 
                                          item.status === orderItemStatus.REFUNDED">
                          Durum Değiştir
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                title="Ürünü İptal Et" 
                                (click)="promptCancelOrderItem(item, order.id)" 
                                [disabled]="item.status === orderItemStatus.DELIVERED || 
                                            item.status === orderItemStatus.CANCELED || 
                                            item.status === orderItemStatus.CANCELLED_BY_SELLER || 
                                            item.status === orderItemStatus.REFUNDED ||
                                            item.status === orderItemStatus.SHIPPED">
                          İptal Et
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>

<!-- Change Item Status Modal -->
<app-change-item-status-modal 
  *ngIf="isChangeStatusModalVisible && selectedItemForStatusChange && selectedOrderForStatusChange"
  [isVisible]="isChangeStatusModalVisible"
  [item]="selectedItemForStatusChange"
  [order]="selectedOrderForStatusChange"
  (closeModal)="handleCloseChangeStatusModal()"
  (saveStatus)="handleSaveItemStatus($event)">
</app-change-item-status-modal>
